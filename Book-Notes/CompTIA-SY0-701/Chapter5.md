# Chapter 5: Security Assessment and Testing
<< [Back to the main page](README.md) 
<br>
<br>
< [Go to Chapter 4: Social Engineering and Password Attack](Chapter4.md)
<br>
[Go to Chapter 6: ] > 
----------------------------------------------

# Table of Content
- [Exercise](#exercise)
- [vulnerability Scanning](#vulnerability-scanning)
    - [Risk Appetite](#risk-appetite)
    - [Regulatory Requirements](#regulatory-requirements)
    - [Constraints to Vulnerability Scanning](#constraints-to-vulnerability-scanning)
        - [Technical Constraints](#technical-constraints)
        - [Business Constraints](#business-constraints)
        - [Licensing Constraints](#licensing-limitations)

    - [Scanner Configuration](#scanner-configuration)
        - [Scanner Sensitivity Level](#scan-sensitivity-levels)
        - [Scan Prespective](#scan-perspective)
        - [Scan Plugins](#scanner-plugins)
        - [Credential Scan](#credential-scan)
        - [Security Content Automation Protocol (SCAP)](#security-content-automation-protocol-scap)

    - [Scanning Tools](#scanning-tools)

- [CVSS Score](#cvss-score)
    - [Attack Vector Metric (AV)](#attack-vector-metric-av)
    - [Attack Complexity Metric (AC)](#attack-complexity-metric-ac)
    - [Privileged Required Metric (PR)](#privilege-required-metric-pr)
        - [Scope Metric (S)](#scope-metric-s)

    - [User Inetraction Metric (UI)](#user-interaction-metric-ui)
    - [Confidentiality Metric (C)](#confidentiality-metric-c)
    - [Integrity Metric (I)](#integrity-metric-i)
    - [Availability Metric (A)](#availability-metric-a)
    - [Score Iniepreting](#score-interpreting)

- [Vulnerability Classification](#vulnerability-classifiction)
    - [Patch Management](#patch-management)
    - [Legacy System](#legacy-system)
    - [Weak Configuration](#weak-configuration)
    - [Error Message](#error-message)
    - [Insecure Protocols](#insecure-protocols)
    - [Weak Cryptography](#weak-cryptography)

- [Penetration Testing](#penetration-testing)
    - [Physical Penetration Testing](#physical-penetration-testing)
    - [Offensive Penetration Testing](#offensive-penetration-testing)
    - [Defensive Penetration Testing](#defensive-penetration-testing)
    - [Known Environment](#known-environment)
    - [Unknown Environment](#unknown-environment)
    - [Rule of Engagement (RoE
    )](#rule-of-engagement-roe)
    - [Common Step for Penetration Testing](#common-step-for-penetration-testing)
        - [Pre-engagement](#pre-engagement)
        - [Information Gathering](#information-gathering)
        - [Running the Test](#running-the-test)
        - [Cleaning Up](#cleaning-up)
        - [Post-Engagement](#post-engagement)
        - [Lesson Learn](#lesson-learn)

- [Security Audits](#security-audits)
    - [Responsible Disclosure Programs](#responsible-disclosure-programs)
        - [Bug Bounty Program](#bug-bounty-program)

    - [Internal Audits](#internal-audits)
    - [External Audits](#external-audits)
    - [Auditing Standards](#auditing-standards)

- [Vulnerability Life Cycle](#vulnerability-life-cycle)
- [Threat Hunting](#threat-hunting)

# Exercise

[Back to Table of Content](#table-of-content)

# Vulnerability Scanning
- Vulnerability Scanning - Identifying System Weakness
- Less intrusive than `penetration testing`
- Not 100% accuracy - require `penetration testing` to validate it
    - False Negative - miss the vulnerability
    - False Positive - vulnerability is reported to be exist which is not

- Identifying Scan Targets
    - What is in the target?
    - Is target exposed to the internet?
    - What services are offered ?
    - Production, Test, or Development System?
    - The target website hosted on their own server or VPS or other providers?
    
- Determining Scan Frequency

[Back to Table of Content](#table-of-content)

## Risk Appetite
- Willingess to tolerate risk within the environment

[Back to Table of Content](#table-of-content)

## Regulatory requirements
- Vulnerability may be required by compliance
    - Payment Card Industry Data Security Standard (PCI DSS)
        - Scan at least once per quarter

    - Federal Information Security Modernization Act (FISMA)

[Back to Table of Content](#table-of-content)

## Constraints to Vulnerability Scanning

[Back to Table of Content](#table-of-content)

### Technical Constraints
- Intrusive scanning can be blocked by firewall
- Intrusive scanning can affect some systems
- Some scanner may only be capable for performing a certain number of a scans per day
- Scanning may take too much time
- Network issues

[Back to Table of Content](#table-of-content)

## Business Constraints
- High business activity period - scanning can disrupt it

[Back to Table of Content](#table-of-content)

## Licensing Limitations
- Some scanner bandwidth can be limited by subscription
- Some features of scanner can be limited by subscription
- Frequency of scanner can be limited by subscription
    - Nessus Essential - limited 16 scan over time

[Back to Table of Content](#table-of-content)

## Scanner Configuration

[Back to Table of Content](#table-of-content)

### Scan Sensitivity Levels
- Level of intrusiveness
- Higher level = Higher chance to be detected and blocked
- Higher level = Higher chance to disrupt/crash the system
- Lower level = Higher time consumption
- Consider the `sensitivity` of the system

[Back to Table of Content](#table-of-content)

### Scan Perspective
- External Scan - run scanner from the external
    - Easily to be detected and blocked by IPS
    - Test firewall and IPS/IDS

- Internal Scan - run scanner in the internet network
    - May install `agent` in each server or devices. - scan device vulnerability and configuration and send to the centralized scanner
    - Similar when attacker gain the access to the internal networks

[Back to Table of Content](#table-of-content)

### Scanner Plugins
- A scanner tools or software can enhance their ability by using plugins or add-ons
- Determine which plugins or addons to be utilized in each scan
- Plugins from official or Plugins developed by users
- Nmap with NSE script plugins
- Can integrated with vulnerability feeds (database of vulnerability)
    - Check list of known vulnerability
    - Usually check the software/hardware version with the vulnerability database
    
- Can integrated with open source intelligence (OSINT)

[Back to Table of Content](#table-of-content)

### Credential Scan
- Give permission or dedicated account to the scanner
- No account to the scanner = when hacker initially access the network
- User account to the scanner = similar to insider attack (employee)
- Admin account to the scanner
    - scanner can see everything
    - More vulnerability can be discovered
    - More misconfiguration can be discovered
    - Higher risk to disrupt the system

[Back to Table of Content](#table-of-content)

### Security Content Automation Protocol (SCAP)
- Common Configuration Enumeration (CCE)
    - Standard nomenclature for discussing system configuration

- Common Platform Enumeration (CPE)
    - Standard nomenclature for describing product names and verions
    - Fingerprint of products/platforms

- Common Vulnerabilities and Exposure (CVE)
    - Standard nomenclature for describing security-related software flaws
    - Database of vulnerability

- Common Weakness Enumeration (CWE)
    - List of weakness in software/hardware/system

- Common Vulnerability Scoring System (CVSS)
    - Standard for measuring and describing severity of vulnerability
    - Score the vulnerability

- Extensible Configuration Checklist Description Format (XCCDF)
    - Language specifying checklists and report checklists result

- Open Vulnerability and Assessment Language (OVAL)
    - A language specifying low-level testing procedures used by checklists

[Back to Table of Content](#table-of-content)

## Scanning Tools
- Tenable's Nessus
    - Nessus Essential = Free version but limited to 16 scan over times
    - May of plugins and features
    - Scan infrastructure
    - Scan host
    - Scan web application

- Qualys
- Rapid7's Nexpose
- Open Source Vulnerability Assessment Scanner (OpenVAS) (Free)
- Nmap (Free)
     - Network Scanners
     - Scanner for openning port and services
     - With `NSE script` written in `lua language` - it can scan vulnerability

- Nikto 
    - Web application scanning tools
    - Open source and free

- Arachni Tools
    - Web application scanning tools
    - Open source and free

- Wapiti
    - Web application scanning tools
    - Report in HTML and PDF
    - Open source and free

- Sqlmap
    - scan for sql injection vulnerability of web application

- Whatweb
    - Scan for web technologies

- Wappalyzer
    - Scan for web technologies

- WPscan
    - WPscan = Wordpress + scan
    - Web application scanner
    - focus on web built by `Wordpress`

- OWASP ZAP
    - open-source web application
    - created by OWASP
    - can also use to test and exploit the web application

- Aircrack-ng
    - Wireless vulnerability scanning
    - Wireless cracking
    
- Searchsploit
    - Vulnerability search database
    - Provided system name, version to get the list of exising vulnerability

- War driving
    - Not a tools
    - driving around the company to find some entry or wifi access

- Metasploit
    - Can use to enumeration, scanning for vulnerability
    - Pack with exploitation modules
    - Least likely to used during the information gathering phase

- Routersploit
    - metasploit for router

[Back to Table of Content](#table-of-content)

# CVSS Score
- Standard for scoring the detected vulnerability
- Many of scanner software can provide CVSS score automatically
- Manually detected vulnerability require score to be calculated manually
- Prioritizing the vulnerability
- Each score range has it own label (0 - 10)
    - 0.1 - 3.9 = Low
    - 4.0 - 6.9 = Medium
    - 7.0 - 8.9 = High
    - 9.0 - 10.0 = Critical

- Consists of many metrics used to calculate the final overall score

[Back to Table of Content](#table-of-content)

## Attack Vector Metric (AV)
- How attacker would exploit the vulnerability
    - Physical - require physically (real-world) interaction (0.20)
    - Local - require physical or logical access to the target (0.55)
    - Adjacent - require physical or logical access to the LAN or (0.62) internal network of the target
    - Network - can exploit from the internet or remote (0.85)

[Back to Table of Content](#table-of-content)

## Attack Complexity Metric (AC)
- Difficulty of exlpoitation
    - High (H) - require specialized conditions (0.44)
    - Low (H) - do not require specialized conditions (0.77)

[Back to Table of Content](#table-of-content)

## Privilege Required Metric (PR)
- Type of access or account used for exploitation
    - High (H) - require admin access
        - 0.270 for unchanged scope
        - 0.50 for changed scope

    - Low (L) - require user account/access
        - 0.62 for unchanged scope
        - 0.68 for changed scope
    
    - None (N) - no privilege/access/account is required
        - 0.85 for both changed or unchanged

[Back to Table of Content](#table-of-content)

### Scope Metric (S)
- Can it affect system components beyond the scope of the vulnerability?
- No score is assigned to this metric
- Reflect the value of [privileges required metric](#privilege-required-metric-pr)
    - Unchanged (U) - exploitation affect resources managed by the same security authority
    - Changed (C) - exploitation affect beyond the scope

[Back to Table of Content](#table-of-content)

## User Interaction Metric (UI)
- None (N) - do not require user interaction (0.85)
- Require (R) - require user interaction (0.62)

[Back to Table of Content](#table-of-content)

## Confidentiality Metric (C)
- None (N) - no impact to confidentiality (0)
- Low (L) - some impact to confidentiality (0.22)
- High (H) - all information is compromised (0.56)

[Back to Table of Content](#table-of-content)

## Integrity Metric (I)
- None (N) (0)
- Low (L) (0.22)
- High (H) - all information can be modified by attacker at will (0.56)

[Back to Table of Content](#table-of-content)

## Availability Metric (A)
- None (N) (0)
- Low (L) - system performance is degraded (0.22)
- High (H) - system is completely shutdown (0.56)

[Back to Table of Content](#table-of-content)

## Score interpreting
- Raw score representation
    - CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    - Metric:Score
    
- Summarizing the score
    - Calculate impact sub-score (ISS)
        - ISS = 1 - [(1 - C) x (1 - I) x (1 - A)]
        
    - Calculate impact score
        - Impact = 6.42 x ISS

    - Calculate Exploitability score
        - Exploitability = 8.22 x AV x AC x PR x UI
        - Be careful of `Privilege Require` score - the scope metric can change score value (changed vs unchanged)

    - Calculate base score (overall score)
        - If the `Impact` = 0, the score is `0`
        - If scope metric is `Unchanged` - base score = Impact + Exploitability
        - If scope metric is `Changed` - base score = (Impact + exploitability) x 1.08
        - If score greater than 10, `round to 10`

    - Calculate CVSS score via online website is useful
    - CVE also provide CVSS score for each vulnerability

[Back to Table of Content](#table-of-content)

# Vulnerability Classifiction

[Back to Table of Content](#table-of-content)

## Patch Management
- The system is required update
- outdated system can process vulnerability
    - CVE contains list of vulnerability classified by system version/framework
    - Apache 2.4.18
    - Linux Kernel 2.6
    - jquery 1.11.0

- `searchsploit` is very useful

[Back to Table of Content](#table-of-content)

## Legacy System
- The system is required update - but the update cannot be performed
    - software compability
    - hardware compability
    - update is no longer support by provider

- Many of organization still use Windows XP, Windows 7
    - Their legacy program cannot work with updated operating system
    - Migrating/Update cost is not worth it

- Many of organization still use Microsoft Server 2003
- A lot of vulnerability can be found
    - Require [compensating controls](Chapter1.md/#compensating-controls)

[Back to Table of Content](#table-of-content)

## Weak Configuration
- Configuration is very weak, novice
- Misconfiguration
- Use default configuration
    - Default credentials (Top vulnerability of IoT devices)

- Open up unnecessary service or port
- Lack of `principle of least privilege`

[Back to Table of Content](#table-of-content)

## Error Message
- System provide too much error message when crash
    - Help attacker to gain more idea
    - Help attacker to gain more insight
    - Help attacker to understand the security controls better

- May expose configuration value
- Enable for debugging but forget to remove in production

[Back to Table of Content](#table-of-content)

## Insecure Protocols
- outdated protocols 
    - HTTP 1.1, HTTP 2
    - TLS vs SSL
    - OpenSSH 7.0 vs OpenSSH 8.0

- weak protocol
     - Telnet vs SSH
     - HTTP vs HTTPS
     - SMTP vs SMTPS
     - FTP vs FTPS, SFTP
     - TLS vs SSL

[Back to Table of Content](#table-of-content)

## Weak Cryptography
- DES vs AES (better)
- RC4 cipher VS AES (better)
- MD5 vs SHA256 (better)
- Some system enable weaker cryptography for backward compability
    - Legacy system can interact with it

[Back to Table of Content](#table-of-content)

# Penetration Testing
- More intrusive than `vulnerability scanning`
- Mimics the hacker approach
    - Hack the system
    - Exploit the system from the result of vulnerability scanning tools

- Verify the vulnerability scanning result
- Identify the missing vulnerability that is not shown up in vulnerability scanner

- Required by some compliance
- Hack to validate the weakness not to destroy the system
- Can provide essential information to enhance security controls

[Back to Table of Content](#table-of-content)

## Physical Penetration Testing
- Security camera testing
- Theft detectors testing
- Exit alarms on emergency exits
- Burglar alarm

[Back to Table of Content](#table-of-content)

## Offensive Penetration testing
- technical testing
- focus on validating the system vulnerability/weakness
- network hacking
- windows hacking
- application hacking
- digital system hacking
- phishing

[Back to Table of Content](#table-of-content)

## Defensive penetration testing
- focus on testing the security controls
- check the SOC performance
- check the SIEM performance
- check the EDR performance
- check the effectiveness of policies, procedures and technologies of detecting the threats
- check for business continuity plan

[Back to Table of Content](#table-of-content)

## Known environment
- Penetration testing with supportive information of the system
- Knwon as `white box`
    - more accuracy result

- If the information is partially provided to the tester, it is called `gray box`
    - similar to internal threat (familiar and able to access some internal resources)
    - known as `partially known environment`

[Back to Table of Content](#table-of-content)

## Unknown environment
- No supportive information is given to the tester
- known as `black box`
    - Similar to hacker from the outside
    - Take a lot of time (especially study about the target)
    - Most expensive
    - Most reliable

[Back to Table of Content](#table-of-content)

## Rule of Engagement (RoE)
- document describe the work of penetration testing project
- timeline for engagement
- location of testing
- target or scope to be tested
- allowed and prohibited techniques during the testing
    - `phishing` is usually be prohibited
    - `DDoS` is usually be prohibited that it can disrupt the business

- Data handling requirements
    - Deal with sensitive data found during the penetration testing
    - Cracking the encrypted data

- Resource used in testing
    - Dedicated account for the tester
    - Dedicated VPN or devices for the tester

- Legal concern
- How communication will occur
    - If somethings went wrong during test, which people to be contact?
    - If testing is complete, which people to be sent the report
    - Which people will be known of penetration testing project
    - May tell the SOC to give some `exceptions` of firewall/IPS/IDS/log to assist the tester work.
    - May not tell the blue team about testing (to test their performance)
    - May not tell all employee about testing (to test their awareness and policies)

[Back to Table of Content](#table-of-content)

## Common Step for penetration testing

[Back to Table of Content](#table-of-content)

### Pre-engagement
- Deal with the customer
- Establishing the rule of engagement
- Contracting
    - Non-Disclosure Agreement (NDA)
    - Service Level Agreement (SLA)
        - Level of service expected and include metrics by which service is measured

    - Master Service Level Agreement (MSA)
        - Contract for future work
        - May be testing again when the customer fix the vulnerability
        - Remidation testing
        - Penetration Testing Subscription
        - May be long term contract

    - Statement of Work (SoW)
        - Rule of engagement document
        - Work methodology
        - Scope

    - Legal contract
    - Team management
    - Clarify the work and scope
    - Planning
    - Post-engagement agreement

[Back to Table of Content](#table-of-content)

### Information Gathering
- Least intrusive step of penetration testing
- Gather all information about the target
    - Port and services
    - domain and subdomain
    - web server, mail server, etc.
    - people, job posting, email, leaked credentials
    - technologies used by the target
    - directory brute force
    - discovery firewall

- Known as `reconnaissance`
- Sometimes knwon as `enumeration`
    - Gather the information by actively interact with the target
    - Try all of possible username
    - Probe the configuration
    - Probe the rules

- Vulnerability Scanning
- Passive Reconnaissance
    - gather information without interact with the target
    - or interact to the target as normal activity
    - WHOIS lookup
    - NSlookup
    - Search Engine
    - CVE Search
    - Hacking database
    - HaveIBeenpwned
    - Wappalyzers, whatweb, cookies decoding

- Active Reconnaissance 
    - intrusively gather information from the target
    - Vulnerability scan, Nessus
    - port scans
    - network scans
    - footprintings
    - Wapiti, OWASP Zap, Nikto, Nmap, WPScan, Brute force, Dirbuster
    - Gobuster, Burp Suite, Sqlmap

- Discover the entry and exit doors
- Discovery the Wifi

[Back to Table of Content](#table-of-content)

### Running the test

- Exploitation
    - Utilize the vulnerability to acheive their objectives
        - Gain access to the system
        - Leak the sensitive information
        - Privilege escalation
        - Backdoors, persistence
        - Shutdown the system
        - Hide their trace

- Initial access
    - gain access to the company's network

- Privilege Escalation
    - change from non-user to user
    - change from human account to system account
    - change from normal user to higher permissioned user
    - change from user to admin
    - horizontal privilege escalation = gain access to other account that have the same permission sets
        - Employee A account to Employee B account

    - vertical privilege escalation = gain access to the other account that has more permission sets
        - normal user up to admin 
    
    - local admin to domain admin
    - normal user to root user

- Pivoting, Lateral movement
    - gain access to other devices from the compromised target
    - gain access to other system from the compromised target
    - gain access to other network from the compromised target

- Persistence
    - Installing `backdoor`
    - allow tester to regain access at will

[Back to Table of Content](#table-of-content)

### Cleaning Up
- Remove any evidence or artifacts from the system after finish the testing
- Remove tester's account
- Remove tester's backdoor, reverse shell, installed program
- Remove tester's tool installed in the target

[Back to Table of Content](#table-of-content)

### Post-Engagement
- Creating Report
- Report and Present to the customer
- Dealing with future discussion
    - Retest after company give the remidiation
    - Future contracting
    - Exchange information between tester and customer

[Back to Table of Content](#table-of-content)

### Lesson Learn
- exchange the experience of testing during the team member
- sharing the techniques used by each member
- discuss of flawness and success in the work
- suggestion and recommendation
- future planning

[Back to Table of Content](#table-of-content)

# Security Audits
- verify that the system/target/company has adequate security controls
- verify if security controls is adequate to `compliance`
- verify if security controls is adequate to `legal requirement`
- verify if security controls is adequate to earn some standard verification, certification

[Back to Table of Content](#table-of-content)

## Responsible Disclosure Programs
- allow security researchers to securely share information about the provider's product vulnerabilities

[Back to Table of Content](#table-of-content)

### Bug Bounty Program
- one type of reponsible disclosure programs
- any people who find the vulnerability will obtain the reward from the product's provider
- Hunting down the vulnerability and earn the bounty

[Back to Table of Content](#table-of-content)

## Internal Audits
- Security auditing perform by organization's internal staff
- can be bias (scare of executive staff, threathened by CEO)
    - executive staff scare of their reputation loss
    - ignore some vulnerability
    - ignore some flaws

- can be a part of `compliance` requirement
- can be a part of `legal requirement`

[Back to Table of Content](#table-of-content)

## External Audits
- Free from bias from executive staff of the company
- Independent from company's internal bias
- third-party
- high degree of external validity
- example of audit firms
    - Ernst & Young
    - Deliotte
    - PwC
    - KPMG

- many standard for external audit provider
    - Statement on Standards for Attestation Engagements document 18 (SSAE 18)
    - The American Institute of Certified Public Acccountants (AICPA)

[Back to Table of Content](#table-of-content)

## Auditing Standards
- Control Objectives fo Information and related Technologies (COBIT)
    - maintained by The Information System Audit and Control Association (ISACA)

- Internaltional Organization for Standardization (ISO)
    - ISO 27001 audit
    - ISO 27002 audit

[Back to Table of Content](#table-of-content)

# Vulnerability Life Cycle
- vulnerability identification (vulnerability is found)
    - vulnerability scan
    - penetration testing
    - result of auditing

- vulnerability analysis
    - confirm for validity (false positive or false negative?)
    - prioritizing and categorizing
        - CVSS and CVE

    - Risk analysis

- vulnerability response and remidation (fix the vulnerablity)
    - Apply a patch
    - Update the system
    - Implement additional controls
    - Revise the existing controls
    - Purchase the insurance
        - transfer the financial risk of the vulnerability to other people

    - grant exception and exemption to the system
    - compensating controls
    - more

- validation of remidiation (check if the solution for vulnerability is worked)
    - Retest
    - Penetration testing again
    - Vulnerability scan again
    - If the flaw still be found, `go back to the vulnerability analysis`

- Reporting
    - summarizing
    - providing details
    - highlighting any trends
    - offering recommendation

[Back to Table of Content](#table-of-content)

# Threat Hunting
- May use skills from penetration testing
- Hunting the threat not the vulnerability
    - Detected unusual request from some IP
    - Investigate that IP
    
    - Detected unsual website requested by employee
    - Investigate that website

    - Information is compromised
    - Track the source, find the root cause, find the real threat

- Hunt down the attacker
- Hunt down the threat

[Back to Table of Content](#table-of-content)
----------------------------------------------------------------
< < [Go to Chapter 4: Social Engineering and Password Attack](Chapter4.md)
<br>
[Go to Chapter 6: ] > 